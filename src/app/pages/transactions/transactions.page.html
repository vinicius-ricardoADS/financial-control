<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Lançamentos</ion-title>
  </ion-toolbar>
  <ion-toolbar>
    <ion-searchbar
      [(ngModel)]="searchTerm"
      (ionInput)="onSearchChange($event)"
      placeholder="Buscar lançamentos..."
      animated="true"
    ></ion-searchbar>
  </ion-toolbar>
  <ion-toolbar>
    <ion-segment [(ngModel)]="filterType" (ionChange)="onFilterChange($event)">
      <ion-segment-button value="all">
        <ion-label>Todas</ion-label>
      </ion-segment-button>
      <ion-segment-button [value]="ReleaseTypes.INCOME">
        <ion-label>Receitas</ion-label>
      </ion-segment-button>
      <ion-segment-button [value]="ReleaseTypes.EXPENSE">
        <ion-label>Despesas</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="transactions-container">
    <ion-list *ngIf="filteredTransactions.length > 0">
      <ion-item *ngFor="let transaction of filteredTransactions" lines="full">
        <div class="transaction-icon" slot="start">
          <span class="category-icon">{{ transaction.category_icon }}</span>
        </div>
        <ion-label>
          <h2>{{ transaction.description }}</h2>
          <p>{{ transaction.category_name }} • {{ formatDate(transaction.date) }}</p>
          <p class="transaction-meta">
            <span class="recurrence-badge">{{ getRecurrenceLabel(transaction.recurrence_type) }}</span>
            <span
              class="status-badge"
              [class.paid]="transaction.payment_status === 'pago'"
              [class.pending]="transaction.payment_status !== 'pago'">
              {{ getPaymentStatusLabel(transaction.payment_status) }}
            </span>
          </p>
          <p *ngIf="transaction.notes" class="notes">{{ transaction.notes }}</p>
        </ion-label>
        <ion-label slot="end" class="amount-label">
          <h2 [class]="getTransactionClass(transaction.release_type)">
            {{ transaction.release_type === ReleaseTypes.INCOME ? '+' : '-' }}
            {{ formatCurrency(transaction.value) }}
          </h2>
          <p *ngIf="transaction.payment_method" class="payment-method">
            {{ transaction.payment_method }}
          </p>
        </ion-label>
      </ion-item>
    </ion-list>

    <!-- Estado vazio -->
    <div class="empty-state" *ngIf="filteredTransactions.length === 0">
      <ion-icon name="search" size="large"></ion-icon>
      <p>Nenhum lançamento encontrado</p>
      <p class="empty-subtitle">Nenhum lançamento para este mês</p>
    </div>
  </div>

  <!-- FAB Button -->
  <ion-fab slot="fixed" vertical="bottom" horizontal="end">
    <ion-fab-button (click)="openModal()">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <!-- Modal de criação -->
  <ion-modal [isOpen]="isModalOpen" (didDismiss)="closeModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar color="primary">
          <ion-buttons slot="start">
            <ion-button (click)="closeModal()">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
          <ion-title>Novo Lançamento</ion-title>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <form (ngSubmit)="submitTransaction()">
          <!-- Tipo de lançamento -->
          <div class="type-selector">
            <ion-segment [(ngModel)]="formData.release_type_id" name="release_type_id">
              <ion-segment-button [value]="ReleaseTypesId.INCOME">
                <ion-icon name="arrow-up"></ion-icon>
                <ion-label>Receita</ion-label>
              </ion-segment-button>
              <ion-segment-button [value]="ReleaseTypesId.EXPENSE">
                <ion-icon name="arrow-down"></ion-icon>
                <ion-label>Despesa</ion-label>
              </ion-segment-button>
            </ion-segment>
          </div>

          <!-- Descrição -->
          <ion-item>
            <ion-label position="stacked">Descrição *</ion-label>
            <ion-input
              [(ngModel)]="formData.description"
              name="description"
              type="text"
              placeholder="Mínimo 6 caracteres"
              required
              minlength="6"
            ></ion-input>
          </ion-item>

          <!-- Valor -->
          <ion-item>
            <ion-label position="stacked">Valor *</ion-label>
            <ion-input
              [(ngModel)]="formData.value"
              name="value"
              type="number"
              placeholder="0.00"
              required
              min="0.01"
              step="0.01"
            ></ion-input>
          </ion-item>

          <!-- Categoria -->
          <ion-item>
            <ion-label position="stacked">Categoria *</ion-label>
            <ion-select
              [(ngModel)]="formData.category_id"
              name="category_id"
              placeholder="Selecione uma categoria"
              interface="action-sheet"
            >
              <ion-select-option *ngFor="let cat of categories" [value]="cat.id">
                {{ cat.icon }} {{ cat.category }}
              </ion-select-option>
            </ion-select>
          </ion-item>

          <!-- Data -->
          <ion-item class="date-item">
            <ion-label position="stacked">Data *</ion-label>
            <div class="date-button-wrapper">
              <ion-datetime-button datetime="transaction-date"></ion-datetime-button>
            </div>
          </ion-item>
          <ion-popover [keepContentsMounted]="true">
            <ng-template>
              <ion-datetime
                id="transaction-date"
                [value]="formData.date"
                (ionChange)="onDateChange($event)"
                presentation="date"
                locale="pt-BR"
              ></ion-datetime>
            </ng-template>
          </ion-popover>

          <!-- Método de pagamento -->
          <ion-item>
            <ion-label position="stacked">Método de pagamento *</ion-label>
            <ion-input
              [(ngModel)]="formData.payment_method"
              name="payment_method"
              type="text"
              placeholder="Ex: PIX, Cartão de Crédito..."
              required
              minlength="3"
            ></ion-input>
          </ion-item>

          <!-- Tipo de recorrência -->
          <ion-item>
            <ion-label position="stacked">Tipo de recorrência</ion-label>
            <ion-select
              [(ngModel)]="formData.recurrence_type_id"
              name="recurrence_type_id"
              interface="action-sheet"
            >
              <ion-select-option [value]="RecurrenceTypesId.LOOSE">Avulsa</ion-select-option>
              <ion-select-option [value]="RecurrenceTypesId.FIXED">Fixa</ion-select-option>
              <ion-select-option [value]="RecurrenceTypesId.VARIABLE">Variável</ion-select-option>
              <ion-select-option [value]="RecurrenceTypesId.RECURRENCE">Recorrente</ion-select-option>
            </ion-select>
          </ion-item>

          <!-- Status de pagamento -->
          <ion-item>
            <ion-label position="stacked">Status de pagamento</ion-label>
            <ion-select
              [(ngModel)]="formData.payment_status_id"
              name="payment_status_id"
              interface="action-sheet"
            >
              <ion-select-option [value]="PaymentStatusId.PENDING">Pendente</ion-select-option>
              <ion-select-option [value]="PaymentStatusId.PAID">Pago</ion-select-option>
            </ion-select>
          </ion-item>

          <!-- Observações -->
          <ion-item>
            <ion-label position="stacked">Observações</ion-label>
            <ion-textarea
              [(ngModel)]="formData.notes"
              name="notes"
              placeholder="Observações opcionais..."
              rows="3"
            ></ion-textarea>
          </ion-item>

          <!-- Botões -->
          <div class="form-buttons">
            <ion-button
              expand="block"
              type="submit"
              [disabled]="!isFormValid() || isSubmitting"
            >
              {{ isSubmitting ? 'Salvando...' : 'Salvar Lançamento' }}
            </ion-button>
          </div>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
