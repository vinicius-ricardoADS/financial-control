<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Lançamentos</ion-title>
  </ion-toolbar>

  <!-- Seletor de Ano -->
  <ion-toolbar class="year-toolbar">
    <div class="year-selector">
      <ion-button fill="clear" size="small" (click)="previousYear()" [disabled]="!canGoToPreviousYear()">
        <ion-icon name="chevron-back" slot="icon-only"></ion-icon>
      </ion-button>
      <span class="year-label">{{ selectedYear }}</span>
      <ion-button fill="clear" size="small" (click)="nextYear()" [disabled]="!canGoToNextYear()">
        <ion-icon name="chevron-forward" slot="icon-only"></ion-icon>
      </ion-button>
    </div>
  </ion-toolbar>

  <!-- Seletor de Meses em Grid -->
  <ion-toolbar class="months-toolbar">
    <div class="months-grid">
      <button
        *ngFor="let month of months"
        class="month-btn"
        [class.selected]="isMonthSelected(month.value)"
        [class.has-data]="hasTransactionsInMonth(month.value)"
        [class.current]="isCurrentMonth(month.value)"
        (click)="selectMonth(month.value)">
        <span class="month-label">{{ month.label }}</span>
        <span class="month-indicator" *ngIf="hasTransactionsInMonth(month.value)"></span>
      </button>
    </div>
  </ion-toolbar>

  <!-- Busca -->
  <ion-toolbar>
    <ion-searchbar
      [(ngModel)]="searchTerm"
      (ionInput)="onSearchChange($event)"
      placeholder="Buscar lançamentos..."
      animated="true"
    ></ion-searchbar>
  </ion-toolbar>

  <!-- Segmento de Tipos - CORRIGIDO -->
  <ion-toolbar class="segment-toolbar">
    <ion-segment [(ngModel)]="filterType" (ionChange)="onFilterChange($event)" mode="ios">
      <ion-segment-button value="all">
        <ion-label>Todas</ion-label>
      </ion-segment-button>
      <ion-segment-button [value]="ReleaseTypes.INCOME">
        <ion-label>Receitas</ion-label>
      </ion-segment-button>
      <ion-segment-button [value]="ReleaseTypes.EXPENSE">
        <ion-label>Despesas</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="transactions-container">
    <!-- Card de Resumo -->
    <div class="summary-cards" *ngIf="filteredTransactions.length > 0">
      <div class="summary-card income">
        <div class="summary-icon">
          <ion-icon name="trending-up"></ion-icon>
        </div>
        <div class="summary-info">
          <span class="summary-label">Receitas</span>
          <span class="summary-value">{{ formatCurrency(totalIncome) }}</span>
        </div>
      </div>
      <div class="summary-card expense">
        <div class="summary-icon">
          <ion-icon name="trending-down"></ion-icon>
        </div>
        <div class="summary-info">
          <span class="summary-label">Despesas</span>
          <span class="summary-value">{{ formatCurrency(totalExpense) }}</span>
        </div>
      </div>
      <div class="summary-card balance" [class.positive]="totalBalance >= 0" [class.negative]="totalBalance < 0">
        <div class="summary-icon">
          <ion-icon name="wallet-outline"></ion-icon>
        </div>
        <div class="summary-info">
          <span class="summary-label">Saldo</span>
          <span class="summary-value">{{ formatCurrency(totalBalance) }}</span>
        </div>
      </div>
    </div>

    <!-- Lista Agrupada por Mês -->
    <div class="month-groups" *ngIf="groupedTransactions.length > 0">
      <div class="month-group" *ngFor="let group of groupedTransactions">
        <!-- Header do Mês -->
        <div class="month-header">
          <div class="month-title">
            <ion-icon name="calendar-outline"></ion-icon>
            <span>{{ group.monthLabel }}</span>
          </div>
          <div class="month-summary">
            <span class="month-income">+{{ formatCurrency(group.totalIncome) }}</span>
            <span class="month-expense">-{{ formatCurrency(group.totalExpense) }}</span>
          </div>
        </div>

        <!-- Transações do Mês -->
        <ion-list>
          <ion-item
            *ngFor="let transaction of group.transactions"
            lines="full"
            class="transaction-item"
            button
            detail="false"
            (click)="showTransactionOptions(transaction)">
            <div class="transaction-icon" slot="start">
              <span class="category-icon">{{ transaction.category_icon }}</span>
            </div>
            <ion-label>
              <h2>{{ transaction.description }}</h2>
              <p>{{ transaction.category_name }} • {{ formatShortDate(transaction.date) }}</p>
              <p class="transaction-meta">
                <span class="recurrence-badge">{{ getRecurrenceLabel(transaction.recurrence_type) }}</span>
                <span
                  class="status-badge"
                  [class.paid]="transaction.payment_status === 'pago'"
                  [class.pending]="transaction.payment_status !== 'pago'">
                  {{ getPaymentStatusLabel(transaction.payment_status, transaction.release_type) }}
                </span>
              </p>
            </ion-label>
            <ion-label slot="end" class="amount-label">
              <h2 [class]="getTransactionClass(transaction.release_type)">
                {{ transaction.release_type === ReleaseTypes.INCOME ? '+' : '-' }}
                {{ formatCurrency(transaction.value) }}
              </h2>
              <p *ngIf="transaction.payment_method" class="payment-method">
                {{ transaction.payment_method }}
              </p>
            </ion-label>
          </ion-item>
        </ion-list>
      </div>
    </div>

    <!-- Estado vazio -->
    <div class="empty-state" *ngIf="filteredTransactions.length === 0">
      <ion-icon name="search" size="large"></ion-icon>
      <p>Nenhum lançamento encontrado</p>
      <p class="empty-subtitle">
        {{ selectedMonth !== null ? 'Nenhum lançamento para este mês' : 'Nenhum lançamento para este ano' }}
      </p>
      <ion-button fill="outline" size="small" *ngIf="selectedMonth !== null" (click)="selectMonth(null)">
        Ver todos os meses
      </ion-button>
    </div>
  </div>

  <!-- FAB Button -->
  <ion-fab slot="fixed" vertical="bottom" horizontal="end">
    <ion-fab-button (click)="openModal()">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <!-- Modal de criação/edição -->
  <ion-modal [isOpen]="isModalOpen" (didDismiss)="closeModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar color="primary">
          <ion-buttons slot="start">
            <ion-button (click)="closeModal()">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
          <ion-title>{{ isEditMode ? 'Editar Lançamento' : 'Novo Lançamento' }}</ion-title>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <form (ngSubmit)="submitTransaction()">
          <!-- Tipo de lançamento -->
          <div class="type-selector">
            <ion-segment [(ngModel)]="formData.release_type_id" name="release_type_id">
              <ion-segment-button [value]="ReleaseTypesId.INCOME">
                <ion-icon name="arrow-up"></ion-icon>
                <ion-label>Receita</ion-label>
              </ion-segment-button>
              <ion-segment-button [value]="ReleaseTypesId.EXPENSE">
                <ion-icon name="arrow-down"></ion-icon>
                <ion-label>Despesa</ion-label>
              </ion-segment-button>
            </ion-segment>
          </div>

          <!-- Descrição -->
          <ion-item>
            <ion-label position="stacked">Descrição *</ion-label>
            <ion-input
              [(ngModel)]="formData.description"
              name="description"
              type="text"
              placeholder="Mínimo 6 caracteres"
              required
              minlength="6"
            ></ion-input>
          </ion-item>

          <!-- Valor -->
          <ion-item>
            <ion-label position="stacked">Valor *</ion-label>
            <ion-input
              [(ngModel)]="formData.value"
              name="value"
              type="number"
              placeholder="0.00"
              required
              min="0.01"
              step="0.01"
            ></ion-input>
          </ion-item>

          <!-- Categoria -->
          <ion-item>
            <ion-label position="stacked">Categoria *</ion-label>
            <ion-select
              [(ngModel)]="formData.category_id"
              name="category_id"
              placeholder="Selecione uma categoria"
              interface="action-sheet"
            >
              <ion-select-option *ngFor="let cat of categories" [value]="cat.id">
                {{ cat.icon }} {{ cat.category }}
              </ion-select-option>
            </ion-select>
          </ion-item>

          <!-- Data -->
          <ion-item class="date-item">
            <ion-label position="stacked">Data *</ion-label>
            <div class="date-button-wrapper">
              <ion-datetime-button datetime="transaction-date"></ion-datetime-button>
            </div>
          </ion-item>
          <ion-popover [keepContentsMounted]="true">
            <ng-template>
              <ion-datetime
                id="transaction-date"
                [value]="formData.date"
                (ionChange)="onDateChange($event)"
                presentation="date"
                locale="pt-BR"
              ></ion-datetime>
            </ng-template>
          </ion-popover>

          <!-- Método de pagamento -->
          <ion-item>
            <ion-label position="stacked">Método de pagamento *</ion-label>
            <ion-input
              [(ngModel)]="formData.payment_method"
              name="payment_method"
              type="text"
              placeholder="Ex: PIX, Cartão de Crédito..."
              required
              minlength="3"
            ></ion-input>
          </ion-item>

          <!-- Tipo de recorrência -->
          <ion-item>
            <ion-label position="stacked">Tipo de recorrência</ion-label>
            <ion-select
              [(ngModel)]="formData.recurrence_type_id"
              name="recurrence_type_id"
              interface="action-sheet"
            >
              <ion-select-option [value]="RecurrenceTypesId.LOOSE">Avulsa</ion-select-option>
              <ion-select-option [value]="RecurrenceTypesId.FIXED">Fixa</ion-select-option>
              <ion-select-option [value]="RecurrenceTypesId.VARIABLE">Variável</ion-select-option>
              <ion-select-option [value]="RecurrenceTypesId.RECURRENCE">Recorrente</ion-select-option>
            </ion-select>
          </ion-item>

          <!-- Status de pagamento -->
          <ion-item>
            <ion-label position="stacked">Status de pagamento</ion-label>
            <ion-select
              [(ngModel)]="formData.payment_status_id"
              name="payment_status_id"
              interface="action-sheet"
            >
              <ion-select-option [value]="PaymentStatusId.PENDING">Pendente</ion-select-option>
              <ion-select-option [value]="PaymentStatusId.PAID">{{ formData.release_type_id === ReleaseTypesId.INCOME ? 'Recebido' : 'Pago' }}</ion-select-option>
            </ion-select>
          </ion-item>

          <!-- Observações -->
          <ion-item>
            <ion-label position="stacked">Observações</ion-label>
            <ion-textarea
              [(ngModel)]="formData.notes"
              name="notes"
              placeholder="Observações opcionais..."
              rows="3"
            ></ion-textarea>
          </ion-item>

          <!-- Botões -->
          <div class="form-buttons">
            <ion-button
              expand="block"
              type="submit"
              [disabled]="!isFormValid() || isSubmitting"
            >
              {{ isSubmitting ? 'Salvando...' : (isEditMode ? 'Atualizar Lançamento' : 'Salvar Lançamento') }}
            </ion-button>
          </div>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
